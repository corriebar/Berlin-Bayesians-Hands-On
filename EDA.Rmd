---
title: "Happiness World Report"
author: "Corrie"
date: "February 23, 2019"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F)
```

## The Data
We will be using the data as provided by the World Happiness Report. The report from 2018 can be found [here](https://s3.amazonaws.com/happiness-report/2018/CH2-WHR-lr.pdf). 

For the happiness score, respondents are asked where they stand on the _Cantril Ladder_. The Cantril Ladder consists of 10 steps, where the top is your best possible life and the bottom the worst possible life.

![](cantril_ladder.png)

In this report, the scale goes from 0 to 10, that is, 0 is the worst possible life and 10 the best possible.

The responses are averaged on a country-year level. The report also includes variables that could explain the differences in the happiness scores. Note that these explanatory variables were not used to compute the happiness score. A detailed description of these additional variables, their sources as well as number of respondents per year and country can be found [here](https://s3.amazonaws.com/happiness-report/2018/Appendix1ofChapter2.pdf).


```{r, message=F, warning=F, echo=F}
library(tidyverse)
library(GGally)          # nice pair plots

ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Set1") +scale_fill_brewer(palette="Set1")
unlockBinding("ggplot",parent.env(asNamespace("GGally")))
assign("ggplot",ggplot,parent.env(asNamespace("GGally")))
```
```{r, message=F, warning=F, echo=F}
d <- read_csv("data/WHR2018Chapter2OnlineData.csv") %>%
  rename(happiness =`Life Ladder`, 
         log_gdp =`Log GDP per capita`, 
         social = `Social support`, 
         health = `Healthy life expectancy at birth`, 
         freedom = `Freedom to make life choices`, 
         generosity = Generosity, 
         corruption = `Perceptions of corruption`, 
         pos_affect = `Positive affect`, 
         neg_affect = `Negative affect`, 
         gov_confidence = `Confidence in national government`, 
         democracy = `Democratic Quality`, 
         delivery = `Delivery Quality`, 
         sd_happiness = `Standard deviation of ladder by country-year`, 
         sd_mean_happiness = `Standard deviation/Mean of ladder by country-year`,
         gini = `GINI index (World Bank estimate)`, 
         gini_avg = `GINI index (World Bank estimate), average 2000-15`, 
         gini_household = `gini of household income reported in Gallup, by wp5-year`)
```
The supporting data also includes a region indicator for the different countries. We can roughly sort these region indicators to their continents which makes it easier for plotting later. Note that Australia and New Zealand are in the same region as the US and Canada and thus landed on the continent Americas.
```{r, message=F, warning=F, echo=F}
missing_regions <- c("Comoros" = "Sub-Saharan Africa",
  "Cuba" = "Latin America and Caribbean",
  "Djibouti" = "Middle East and North Africa",
  "Guyana" = "Latin America and Caribbean",
  "Oman" = "Middle East and North Africa",
  "Somaliland region" = "Middle East and North Africa",
  "Suriname" = "Latin America and Caribbean",
  "Swaziland" = "Sub-Saharan Africa")

d2 <- read_csv("data/WHR2018Chapter2OnlineData_supporting_factors.csv") %>%
  select(country, region = `Region indicator`) 



d <- d %>%
  left_join( d2, by="country") %>%
  mutate(region = ifelse(is.na(region), country, region)) %>%
  mutate(region = str_replace_all(region, missing_regions)) %>%
  mutate(continent = fct_collapse(region,
                                  Americas=c("North America and ANZ", "Latin America and Caribbean"),
                                  Africa=c("Middle East and North Africa", "Sub-Saharan Africa" ),
                                  Asia=c("South Asia", "Southeast Asia", "East Asia", 
                                         "Commonwealth of Independent States"),
                                  Europe=c("Central and Eastern Europe", "Western Europe")
                                  )) 
```

The World Happiness Report only provides the Log of the GDP and by the time of publication, the GDP of 2017 wasn't available yet and extrapolated in the report. We can use the updated version of the GDP as provided by the [World Bank](https://data.worldbank.org/indicator/NY.GDP.PCAP.PP.KD). We use the GDP per capita in purchasing power parity
(PPP) at constant 2011 international dollar prices.
```{r, message=F, warning=F}
country_spell_list <- c("Egypt, Arab Rep."="Egypt",
   "Russian Federation"="Russia",
   "Korea, Rep."="South Korea",
   "Yemen, Rep."="Yemen",
   "Slovak Republic"="Slovakia",
   "Iran, Islamic Rep."="Iran",
   "Congo, Rep."="Congo (Brazzaville)",
   "Congo, Dem. Rep."="Congo (Kinshasa)",
   "Hong Kong SAR, China"="Hong Kong S.A.R. of China",
   "Cote d'Ivoire"="Ivory Coast",
   "Kyrgyz Republic"="Kyrgyzstan",
   "Macedonia, FYR"="Macedonia",
   "Lao PDR"="Laos")

gdp <- read_csv("data/worldbank_gdp.csv",
                skip=3) %>%
  rename(country=`Country Name`, country_code=`Country Code`) %>%
  select(country, `1960`:`2017`) %>%
  gather(key="year", value="gdp", `1960`:`2017`) %>%
  mutate(log_gdp = log(gdp),
         year=as.numeric(year)) %>%
  mutate(country = str_replace_all(country, country_spell_list))



d <- d %>%
  select(-log_gdp) %>% 
  left_join( gdp, by=c("country", "year")) %>%
  select(country, region, continent, year, happiness, gdp, log_gdp, social:gini_household)
```

## How happy are people around the world?
So before we look at the explaining factors, let's have a look people are in general around the World.
```{r, warning=F, message=F}
d %>% 
  filter(year==2017) %>%
  ggplot(aes(x=happiness)) +
  geom_histogram(bins=20, fill="steelblue", col="white") +
 # xlim(0,10) +
  labs(x="Happiness", y="Count", title="Happiness in 2017") + 
  geom_vline(xintercept = mean(d %>% filter(year == 2017) %>% pull(happiness))) + 
  scale_x_continuous(breaks = c(0, 2.5,  5, 5.49, 7.5, 10), 
                     labels = c(0, 2.5, "", 5.49, 7.5, 10),
                    limits = c(0, 10) ) + 
  theme_minimal()
```

Even thought the ladder goes from 0 to 10, the worst average rating a country can have is around 2.5 and the best rating is around 7.6. On average, people seem to be more on the happier side.

An intersting question is here, did happiness improve over time? The report goes back to 2005 (though many countries are only included later) and the newest observation is from 2017.
```{r, message=F, warning=F}
trend <- d %>%
  group_by(year) %>%
  summarise(happiness = mean(happiness))

d %>%
  ggplot(aes(x=year, y=happiness)) + 
  geom_line(aes(group=country, col=continent), alpha=0.7, size=0.3) +
  scale_color_manual(values=c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#000000")) +
  scale_x_continuous(breaks=c(2005, 2007, 2010, 2012, 2015, 2017)) +
  geom_line(data=trend, size=1, aes(x=year, y=happiness, col="World Average")) +
  theme_minimal() +
  guides(colour = guide_legend(override.aes = list(alpha=1, size=1.5))) +
  labs(x="Year", y="Happiness", color="Continent", title="Happiness over Time")
```

It seems that overall and for most countries, there is not much of a trend in the happiness score. The happiness drop at the year 2006 seems to be mostly due because that year more countries were included than in the year before.
The top happiness scores seems to be dominated by European countries and the bottom scores are dominated by African countries. We can also see some African countries in the top range.

Let's have a closer look how the happiness scores are distributed geographically over the world. Since there didn't seem too much change in the happiness scores, we simply take the average for each country over all reported years. This way, we can include most countries since some countries have missing observations in some years.
```{r, fig.height=6, fig.width=9, dpi=200}
map_correction <- c("Democratic Republic of the Congo"="Congo (Brazzaville)",
                    "Palestine"="Palestinian Territories",
                    "Republic of Congo"="Congo (Kinshasa)",
                    "Taiwan"="Taiwan Province of China",
                    "USA"="United States",
                    "UK"="United Kingdom")

world <- map_data("world") %>%
  rename(country = region) %>%
  mutate(country = str_replace_all(country, map_correction))

world_map <- world %>%
  left_join(d %>% 
              group_by(country) %>%
              summarize(happiness=mean(happiness), na.rm=T), by="country")

world_map %>% 
ggplot( aes(x=long, y=lat, group=group, fill=happiness)) +
  geom_polygon(col="white", size=0.3) +
  coord_cartesian() +
  scale_fill_distiller(palette="RdYlGn", direction=1) +
  theme_void() +
  labs(fill="Happiness", title="Happiness around the World", subtitle="Average Happiness Score") +
  guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))
```

Most Western Countries seem to get a quite high happiness score in this report while many countries in Africa have quite low scores.

Interesting are here in particular countries such as Yemen, Afghanistan or Cambodia that have very low scores but are surrounded by countries with higher scores (Saudi Arabia and Oman for Yemen; Turkmenistan and Pakistan for Afghanistan; Thailand and Vietnam for Cambodia). Both Yemen and Afghanistan have been in the news the last decades because of ongoing conflicts and crises. While Cambodia has been stable for some time by now, their conflicts during the 90s still seem to affect their happiness level today.

## Suporting Factors
### Economic Factors
Let's have a closer at the supporting factors that are included in the report.
Two different economical indicators are provided: The GDP per capita and the Gini index. The household Gini index measures the inequality among household incomes. A Gini index of 0 signifies perfect equality while a index of 1 means maximal inequality.
The generosity factor is computed with relation to the GDP: People were asked if they have donated to charity in the past month. The binary answers are then aggregated on a national level and regressed on by the GDP per capita. The generosity value is then the residual, that is, it gives an indicator if people give more or less money to charity than would be expected by their GDP.
```{r, fig.height=10, fig.width=10, message=F, warning=F}
d %>% 
  filter(year == 2017) %>%
  select(Happiness=happiness, 
         GDP=gdp, `Log GDP`=log_gdp, 
         `Gini Household`=gini_household, 
         Generosity=generosity, continent) %>%
  ggpairs(mapping=aes(col=continent, alpha=0.5), columns=1:5,
          upper=list(continuous="points"),
          lower=list(continuous="cor"),
          titel="Economical Factors") + 
  theme_minimal() 
```

We can see that the GDP has a positive correlation with the happiness score while the Gini index has a negative correlation (albeit weaker). Generosity only seems to be positively correlated with happiness for European countries.

### Social and Health Factors
Three social factors are included in the data:

- `social`, the answer to the question "If you were in trouble, do you have relatives or friends you can count on to help you whenever you need them, or not?", aggregated on a national level.
- `health`, the Healthy Life Expectation, gives the number of years a person is expected to live in good health.
- `pos_affect` is the average to three questions about how a person felt the previous day: Were they happy, laughed, smiled and were mostly enjoying themselves.
- `neg_affect` is the average to three questions about how a person felt the previous day: Did they worry, were they sad or angry.

```{r, fig.height=10, fig.width=10, message=F, warning=F}
d %>% 
  filter(year == 2017) %>%
  select(Happiness=happiness, 
         `Social Support`=social, 
         `Life Expectation`=health, 
         `Pos. Affect`=pos_affect, 
         `Neg. Affect`=neg_affect, continent) %>%
  ggpairs(mapping=aes(col=continent, alpha=0.5),
          columns = 1:5,
          upper=list(continuous="points"),
          lower=list(continuous="cor"),
          title="Social and Health Factors") +
  theme_minimal()
```

Except for negative affect are all factors strongly positively correlated with happiness. Negative affect is obviously negatively correlated with happiness.

### Political Factors
The data provides 5 political factors:

- `freedom`
- `corruption`
- `gov_confidence`
- `democracy`
- `delivery`

```{r, fig.height=8, fig.width=8}
d %>% 
  filter(year == 2016) %>%
  select_if(is.numeric) %>%
  select(happiness, freedom, corruption, gov_confidence, democracy, delivery) %>%
  pairs()
```


```{r}
top10 <- d %>% filter(year==2017) %>%
  top_n(10, happiness) %>% pull(country)

bottom10 <- d %>% filter(year==2017) %>%
  top_n(-10, happiness) %>% pull(country)

d %>% 
  filter(year == 2017) %>%
  mutate(country = fct_reorder(country, happiness)) %>%
  filter(country %in% top10 |
           country %in% bottom10) %>%
    ggplot(aes(x=country, y=happiness)) +
    geom_hline(yintercept = mean(d$happiness), col="grey") +
    geom_point(col="steelblue", size=3) +
    geom_segment(aes(x=country,
                   xend=country,
                   y=0,
                   yend=10),
               alpha=0.6,
               size=0.1) +
  geom_segment(aes(x=country,
                   xend=country,
                   y=happiness - sd_mean_happiness,
                   yend=happiness + sd_mean_happiness)) +
  labs(title="Top 10 and Bottom 10 Happy Countries", 
    subtitle=paste("Average happiness:",
                      round(mean(d %>% filter(year==2017) %>% pull(happiness), na.rm=T), digits=2)),
       x="", y="Erfolgsquote") +
  coord_flip() + theme_classic()
```


```{r}
d %>%
  filter(year == 2017) %>% 
  ggplot(aes(x=log_gdp, y=happiness, col=continent)) + 
  geom_point() +
  scale_color_brewer(type="qual", palette="Set1") +
  labs(x="Log GDP", y="Happiness", col="Continent") +
  theme_minimal() +
  guides(colour = guide_legend(override.aes = list(size=5))) 
```

## Add Population Data
We can easily add further data. For example, the World Bank also provides yearly [population data](https://data.worldbank.org/indicator/sp.pop.totl)
```{r, warning=F, message=F}
pop <- read_csv("data/worldbank_population.csv",
                skip=3) %>%
  select(country=`Country Name`, `1960`:`2017`) %>%
  mutate(country = str_replace_all(country, country_spell_list)) %>%
  gather(key="year", value="pop", `1960`:`2017`) %>%
  mutate(year = as.numeric(year),
         log_pop = log(pop))
  
d <- d %>%
  left_join(pop, by=c("country", "year"))
```


```{r}
d %>%
  filter(year == 2017) %>% 
  arrange(desc(pop)) %>%
  ggplot(aes(x=log_gdp, y=happiness, fill=continent, size=pop)) + 
  geom_point(shape=21) +
  scale_fill_brewer(type="qual", palette="Set1") +
  scale_size(range=c(1,10), guide=F) +
  labs(x="Log GDP", y="Happiness", fill="Continent") +
  theme_minimal() +
  guides(fill = guide_legend(override.aes = list(size=5))) 
```

[Temperature Data](https://datacatalog.worldbank.org/dataset/climate-change-knowledge-portal-historical-data)
